{"version":3,"sources":["singlis/streaming.cljs"],"mappings":";AAKA,AAAA,AAAKA;AACL,AAAA,AAAKC;AAEL,AAAA,AAAMC;AAAN,AACE,AAAA,AAAiBC;;AAEnB,AAAA,AAAMC;AAAN,AACE,AAAAC,AAAK,AAACH;AAAN,AAAA,AAAAG;AAAA,AAAAA,AACK,AAAcC;AADnB,AAAA,AAAAD;AAEK,AAAmBC;;AAFxBD;;;AAAAA;;;AAIF,AAAA,AAAME;AAAN,AACE,AAASD;;AAEX,AAAA,AAAME;AAAN,AACE,AAAAC,AAAmCH;;AAErC,AAAA,AAAMI;AAAN,AACE,AAAY,AAACF;;AAEf,AAAA,AAAMG,AAASC;AAAf,AACE,AAAAC,AAAqBb,AAAgBc,AAAWF;;AAElD,AAAA,AAAMG,AAAOH;AAAb,AACG,AAAAC,AAAqBZ,AAAmBe,AAAUJ;;AAErD,AAAA,AAAMK,AAAqBC,AAAMC;AAAjC,AACM,AAAUD,AAAMlB,AAAgBmB,AAChC,AAAA,AAAAC;AAAA,AAAQ,AAAAA;;;AAEd,AAAA,AAAMC,AAAqBC,AAAQC,AAAWC,AAAUC,AAAUN;AAAlE,AACM,AAAeG,AAAQG,AAAUN,AAAQlB,AAAmBsB,AAAWC,AACvE,AAAA,AAAAE;AAAA,AAAS,AAAAA;;;AAEf,AAAA,AAAMC;AAAN,AACE,AAAQC,AAAY,AAAAC,AAAW,AAAW,AAAA;;AAE5C,AAAA,AAAAC,AAAMM;AAAN,AAAA,AAAAL,AAAAD;AAAAC,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAC,AAAA,AAAAD,AAAA,AAAA,AAAA,AAAA,AAAAE,AAAAC,AAAAH,AAAAA;AAAA,AAAAI,AAAAJ,AAAA,AAA4BM;AAA5B,AAAAF,AAAAJ,AAAA,AAAkCO;AAAlC,AAAAH,AAAAJ,AAAA,AAA2CN;AAA3C,AACE,AAAMP,AAAM,AAACH,AAAM,AAACL;AACdY,AAAQ,AAACX,AAAQ,AAACD;AAClB6B,AAAI,AAACZ;AACLa,AAAS,AAAA,AAAQ,AAAA,AAAKH;AAH5B,AAIMI;AACAtB,AAAQ,AAAK,AAAGmB,AAAS,AAACI,AAAIJ,AAASE;AAL7C,AAMM,AAACvB,AAAcC,AAAMC,AACrB,AAAA,AACA,AAKA,AACA;AAPA,AAAQ,AAAA,AAAA,AAAA,AAACwB;AACT;AAAA,AAAQ,AAACtB,AACAC,AACA,AAAGiB,AAAIE,AACP,AAAA,AAAGF,AAAIC,AAASC,AAChBhB,AAAUN;AACnB;AAAA,AAAQ,AAAA,AAAA,AAAA,AAACwB;AACT;AAAA,AAAS,AAAA,AAAA,AAAA,AAACA","names":["singlis.streaming/sablier-address","singlis.streaming/testnetDAI-address","singlis.streaming/metamask-installed?","js/window","singlis.streaming/metamask-connected?","and__4115__auto__","js/window.ethereum","singlis.streaming/enable-metamask","singlis.streaming/provider","js/ethers.providers.Web3Provider","singlis.streaming/signer","singlis.streaming/sablier","signer","js/ethers.Contract","singlis.config/sablierABI","singlis.streaming/token","singlis.config/ierc20ABI","singlis.streaming/approve-token","token","deposit","p1__49521#","singlis.streaming/create-stream","sablier","start-time","stop-time","recipient","p1__49522#","singlis.streaming/now","js/Math","js/Date","p__49523","map__49524","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","singlis.streaming/process-form","hours","quantity","now","duration","delay","cljs.core/mod","re-frame.core/dispatch"],"sourcesContent":["(ns singlis.streaming\n  (:require\n   [singlis.config :refer [sablierABI ierc20ABI]]\n   [re-frame.core :as re-frame]))\n\n(def sablier-address \"0xc04Ad234E01327b24a831e3718DBFcbE245904CC\")\n(def testnetDAI-address \"0xc3dbf84Abb494ce5199D5d4D815b10EC29529ff8\")\n\n(defn metamask-installed? []\n  (.hasOwnProperty js/window \"ethereum\"))\n\n(defn metamask-connected? []\n  (and (metamask-installed?)\n       (.isConnected js/window.ethereum)\n       (.-selectedAddress js/window.ethereum)))\n\n(defn enable-metamask []\n  (.enable js/window.ethereum))\n\n(defn provider []\n  (js/ethers.providers.Web3Provider. js/window.ethereum))\n\n(defn signer []\n  (.getSigner (provider)))\n\n(defn sablier [signer]\n  (js/ethers.Contract. sablier-address sablierABI signer))\n\n(defn token [signer]\n   (js/ethers.Contract. testnetDAI-address ierc20ABI signer ))\n\n(defn approve-token [^js/e token deposit]\n  (-> (.approve token sablier-address deposit)\n      (.then #(.wait %))))\n\n(defn create-stream [^js/e sablier start-time stop-time recipient deposit]\n  (-> (.createStream sablier recipient deposit testnetDAI-address start-time stop-time)\n      (.then  #(.wait %))))\n\n(defn now []\n  (.round js/Math (-> (js/Date.) (.getTime) (/ 1000))))\n\n(defn process-form [{:keys [hours quantity recipient]}]\n  (let [token (token (signer))\n        sablier (sablier (signer))\n        now (now)\n        duration (* 3600 (int hours))\n        delay 60\n        deposit (str (- quantity (mod quantity duration)))]\n    (-> (approve-token token deposit)\n        (.then #(re-frame/dispatch [:update-status :processing]))\n        (.then #(create-stream\n                 sablier\n                 (+ now delay)\n                 (+ now duration delay)\n                 recipient deposit))\n        (.then #(re-frame/dispatch [:update-status :finished]))\n        (.catch #(re-frame/dispatch [:update-status :failed])))))\n"]}